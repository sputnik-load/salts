{% extends "base.html" %}
{% block title_content %}
  <title>SALTS: запуск тестов</title>
{% endblock title_content %}
{% block container %}
  <h1>Запуск тестов:</h1>
  <p id="linker" align="right"></p>
  <table id="table"
         data-toggle="table"
         data-url="/run?a=1"
         data-height="800"
         data-side-pagination="server"
         data-pagination="true"
         data-page-list="[10, 20, 50, All]"
         data-row-style="row_style"
         data-sort-name="id"
         data-sort-order="asc"
         data-show-columns="true"
         data-resizable="true"
         data-key-events="true"
         data-ajax="ajax_request"
         data-search="false">
      <thead style="background-color: Bisque">
        <tr>
          <th class="col-sm-1" data-field="id" data-sortable="true"
              data-visible="true" title="ID">ID</th>
          <th class="col-sm-2" data-field="test_name" title="Имя теста"
              data-formatter="test_name_formatter">Имя теста</th>
          <th class="col-sm-2" data-field="tank_host" title="Имя хоста"
              data-formatter="tank_host_formatter">Имя хоста</th>
          <th class="col-sm-2" data-field="action"
              data-formatter="action_formatter" 
              title="Действие">Действие</th>
          <th class="col-sm-2" data-field="status"
              title="Статус">Статус</th>
        </tr>
      </thead>
  </table>
{% endblock container %}
{% block scripts_blk %}
  var targetNodes         = $("#table");
  var MutationObserver    = window.MutationObserver || 
                            window.WebKitMutationObserver;
  var myObserver          = new MutationObserver (mutationHandler);
  var obsConfig           = {childList: true, characterData: true,
                             attributes: true, subtree: true };

  function mutationHandler(mutationRecords) {
    mutationRecords.forEach(function(mutation) {
      if (mutation.type == "childList") {
        $(mutation.addedNodes).each(function() {
          $(this).find('td a').each(function() {
            $(this).editable({
              success: function(response, newValue) {
              },
              display: function(value, sourceData) {
                if ($(this).attr('name') === 'tank_host') {
                  var content = $.fn.editableutils.itemsByValue(value,
                                                                sourceData);
                  $(this).html(content[0]['text']);
                  var action_btns = $('#table #action_btn');
                  var cur_ix = $(this).attr('index');
                  var action_btn = $(action_btns[cur_ix]);
                  if (value == 0) {
                    action_btn.prop('disabled', true);
                  }
                  else {
                    action_btn.prop('disabled', false);
                    var func_name = "runTest(" + action_btn.attr('scid') +
                                    ", " + value + ")";
                    action_btn.attr('onclick', func_name);
                  }
                }
              }
            });
          });
        });
      }
    });
  }

  function ajax_request(params) {
    var resp = $.ajax(params);       
  }
 
  $(document).ready(function() {
    targetNodes.each(function() {
        myObserver.observe(this, obsConfig);
    });
    $.fn.editable.defaults.mode = 'popup';
  });

  function test_name_formatter(v, row, index) {
    return "<a href='#' name='test_name' data-type='text' " +
           "data-placement='right' data-title='Имя теста'>" + 
           row['test_name'] + "</a>";
  }

  function tank_host_formatter(v, row, index) {
    var json_obj = JSON.parse(row['tank_host']);
    json_obj.push({text: "Не выбран", value: "0"});
    return "<a href='#' name='tank_host' index='" + index + "' " +
           "data-source='" + JSON.stringify(json_obj) + "' " +
           "data-type='select' data-value='0'" +
           "data-placement='right' data-title='Имя хоста с танком'></a>";
  }

  function runTest(scenario_id, tank_id, b64line) {
    var data_url = "/shoot/?s=" + scenario_id +
                   "&t=" + tank_id;
    var resp = $.ajax({
      url: data_url,
      type: 'GET',
      dataType: 'json',
      success: function(json) {
        console.log("Response: " + JSON.stringify(json));
        var action_btn = $("#table #action_btn[scid=" + scenario_id + "]")[0];
        var func_name = "stopTest(" + scenario_id + ", " + tank_id + ", " +
                        json['id'] + ")";
        $(action_btn).attr('onclick', func_name);
        $(action_btn).text('Остановить');
      },
      error: function(json) {
        console.log("Response: " + JSON.stringify(json));
      }
    });
  }

  function stopTest(scenario_id, tank_id, shooting_id) {
    var data_url = "/shoot/?stop=" + shooting_id;
    var resp = $.ajax({
      url: data_url,
      type: 'GET',
      dataType: 'json',
      success: function(json) {
        console.log("Response: " + JSON.stringify(json));
        var action_btn = $("#table #action_btn[scid=" + scenario_id + "]")[0];
        var func_name = "stopTest(" + scenario_id + ", " + json['id'] + ")";
                    var func_name = "runTest(" + scenario_id +
                                    ", " + tank_id + ")";
        $(action_btn).attr('onclick', func_name);
        $(action_btn).text('Запустить');
      },
      error: function(json) {
        console.log("Response: " + JSON.stringify(json));
      }
    });
  }

  function action_formatter(v, row, index) {
    return "<button type='button' class='btn btn-primary' " +
           "id='action_btn' scid='" + row['id'] + "' " +
           "onclick=''>Запустить</button>";
  }
{% endblock scripts_blk %}
