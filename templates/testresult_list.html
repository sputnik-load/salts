{% extends "base.html" %}
{% block container %}
  <h1>Результаты тестов:</h1>
  <a href="https://wiki.ptnik.su/pages/viewpage.action?pageId=27040006" target="_blank">Справка</a>
  <p id="linker" align="right"></p>
  <table id="table"
         data-toggle="table"
         data-url="/get_results/"
         data-height="800"
         data-side-pagination="server"
         data-pagination="true"
         data-page-list="[10, 20, 50, All]"
         data-row-style="row_style"
         data-sort-name="dt_finish"
         data-sort-order="desc"
         data-show-columns="true"
         data-resizable="true"
         data-key-events="true"
         data-ajax="ajax_request"
         data-search="false">
      <thead style="background-color: Bisque">
        <tr>
          <th data-field="id" data-visible="false" title="ID">ID</th>
          <th data-field="test_name" data-sortable="true" data-formatter="test_name_formatter" title="Тест">Тест</th>
          <th data-field="test_status" data-sortable="true" data-formatter="test_status_formatter" title="Статус">Статус</th>
          <th data-field="scenario_id" data-sortable="true" data-visible="false" title="ID сценария">Сценарий</th>
          <th data-field="target" data-sortable="true" title="Нагружаемый сервис">Target</th>
          <th data-field="version" data-sortable="true" title="Версия">Версия</th>
          <th data-field="rps" data-sortable="true" title="RPS">RPS</th>
          <th data-field="q99" data-sortable="true" title="99%">99%</th>
          <th data-field="q90" data-sortable="true" title="90%">90%</th>
          <th data-field="q50" data-sortable="true" title="50%">50%</th>
          <th data-field="http_net" title="% ошибок http/net">Ошибки</th>
          <th data-field="duration" data-sortable="true" title="Длительность">Время</th>
          <th data-field="dt_finish" data-sortable="true" title="Время окончания">Окончание</th>
          <th data-field="graph_url" data-formatter="graph_url_formatter" title="График">График</th>
          <th data-field="generator" data-sortable="true" title="Нагрузочная станция">Генератор</th>
          <th data-field="test_id" data-visible="false" data-sortable="true" title="ID теста">ID теста</th>
          <th data-field="ticket_id" data-sortable="true" data-formatter="ticket_id_formatter" title="Задача">Задача</th>
          <th data-field="comment" title="Комментарий">Комментарий</th>
      </tr>
      </thead>
  </table>
{% endblock container %}
{% block scripts_blk %}
    get_args = location.search;
    var a = document.createElement('a');
    var linkText = document.createTextNode("Динамика результатов");
    a.appendChild(linkText);
    a.title = "Графики трендов времён отклика";
    a.href = "/results/graph/" + get_args;    
    var parent = document.getElementById("linker");      
    parent.appendChild(a);      
      
    var $table = $('.table');

    function edit_page_url(edit_url, id) {
      return window.location.protocol + "//" + window.location.host + edit_url + id;
    }

    function ajax_request(params) {
      var url_param = $.url().param();
      for (name in url_param) {
        if (!params.data.hasOwnProperty(name)) {
          params.data[name] = url_param[name];
        }
      }
      if ('cc' in url_param && url_param['cc'] === '0') {
        params.cache = false;
      }
      $.ajax(params);        
    }

    function graph_url_formatter(value) {
      if (value === "") {
        return "-";
      }
      return "<a href='" + value + "'>График</a>";
    }

    function ticket_id_formatter(value) {
      if (value === "") {
        return "-";
      }
      return "<a href='https://task.ptnik.su/browse/" + value + "' target='_blank'>" + value + "</a>";
    }

    function test_name_formatter(value, row) {
      if (value === '') {
        return '-';
      }
      if (row['edit_url'] === '') {
        return value;
      }
      return "<a href='" + edit_page_url(row['edit_url'], row['id']) + "'>" + value + "</a>";
    }

    function test_status_formatter(value, row) {
      var human_values = {
        unk: "Unknown",
        dbg: "Debug",
        pass: "Pass",
        fail: "Fail"
      };
      return human_values[value];
    }

    function row_style(row, index) {
      var css_status_classes = { 
        unk: "unk", 
        dbg: "debug",
        fail: "failed",
        pass: "success"
      };
      if (index % 2 === 0) {
        return {classes: css_status_classes[row["test_status"]] + "_even"};
      }
      return {classes: css_status_classes[row["test_status"]] + "_odd"};
    }
    $('#table').bootstrapTable({
      onDblClickRow: function (row, $element) {
        window.open(edit_page_url(row["id"]));
      }
    });
{% endblock scripts_blk %}
